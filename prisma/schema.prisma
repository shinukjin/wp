// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 사용자 모델
model User {
  id                String    @id @default(cuid())
  email             String    @unique // 계정 (이메일 형식)
  password          String    // 비밀번호
  name              String?   // 이름 (선택사항)
  approved          Boolean   @default(false) // 관리자 승인 여부 (승인 후 로그인 가능)
  isAdmin           Boolean   @default(false) // 관리자 여부
  budget            Int       @default(0) // 현재 예산
  ownMoney          Int       @default(0) // 내 보유금
  loanAmount        Int       @default(0) // 내 대출금
  loanRate          Float     @default(0) // 대출이율 (연이율, %)
  loanPeriod        Int       @default(0) // 대출기간 (개월)
  discordWebhookUrl String?   // 디스코드 웹훅 URL (알림 수신)
  isDeleted         Boolean   @default(false) // 탈퇴유무
  deletedAt         DateTime? // 탈퇴일시
  lastLoginAt       DateTime? // 마지막 접속시간
  createdAt         DateTime  @default(now()) // 가입일
  updatedAt         DateTime  @updatedAt // 수정일시
  weddingPreps      WeddingPrep[] // 결혼 준비 항목들
  realEstates       RealEstate[] // 부동산 항목들
  travelSchedules   TravelSchedule[] // 여행 일정
  connectionRequestsSent     ConnectionRequest[] @relation("ConnectionRequestFrom")
  connectionRequestsReceived ConnectionRequest[] @relation("ConnectionRequestTo")
  connectionsAsUser1 Connection[] @relation("ConnectionUser1")
  connectionsAsUser2 Connection[] @relation("ConnectionUser2")
  weddingPrepUpdates   WeddingPrep[] @relation("WeddingPrepUpdatedBy")
  realEstateUpdates    RealEstate[] @relation("RealEstateUpdatedBy")
  travelScheduleUpdates TravelSchedule[] @relation("TravelScheduleUpdatedBy")
  loginLogs            LoginLog[]
}

// 로그인 로그 (당일 접속량 등 통계용)
model LoginLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// 연결 신청 (상대방 ID로 신청 → 승인 시 연결)
model ConnectionRequest {
  id         String   @id @default(cuid())
  fromUserId String   // 신청자
  toUserId   String   // 수신자
  status     String   @default("pending") // pending | accepted | rejected
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  fromUser   User     @relation("ConnectionRequestFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User     @relation("ConnectionRequestTo", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId])
  @@index([toUserId])
  @@index([fromUserId])
}

// 연결됨 (승인 시 생성, 1:1 연결)
model Connection {
  id        String   @id @default(cuid())
  userId1   String   // 한쪽 사용자 ID (작은 쪽 권장)
  userId2   String   // 다른 쪽 사용자 ID
  createdAt DateTime @default(now())
  user1    User     @relation("ConnectionUser1", fields: [userId1], references: [id], onDelete: Cascade)
  user2    User     @relation("ConnectionUser2", fields: [userId2], references: [id], onDelete: Cascade)

  @@unique([userId1, userId2])
  @@index([userId1])
  @@index([userId2])
}

// 결혼 준비 모델
model WeddingPrep {
  id          String    @id @default(cuid())
  userId      String    // 사용자 ID (소유자)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  updatedById String?   // 마지막 수정자 ID
  updatedBy   User?     @relation("WeddingPrepUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  category    String    // 구분 (예: 예식, 혼수, 신혼여행 등)
  subCategory String?   // 상세구분 (예: 드레스, 메이크업 등)
  content     String    // 내용
  amount      Int       @default(0) // 금액
  status      String    @default("진행중") // 상태 (진행중/완료/취소)
  priority    Int       @default(0) // 우선순위 (0: 낮음, 1: 보통, 2: 높음)
  dueDate     DateTime? // 예정일
  completedAt DateTime? // 완료일
  note        String?   // 비고
  isDeleted   Boolean   @default(false) // 삭제유무
  deletedAt   DateTime? // 삭제일시
  createdAt   DateTime  @default(now()) // 생성일
  updatedAt   DateTime  @updatedAt // 수정일시

  @@index([userId])
  @@index([category])
  @@index([status])
}

// 부동산 모델
model RealEstate {
  id          String    @id @default(cuid())
  userId      String    // 사용자 ID (소유자)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  updatedById String?   // 마지막 수정자 ID
  updatedBy   User?     @relation("RealEstateUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  category    String    // 구분 (매매/전세/월세 등)
  region      String    // 지역
  rooms       Int       @default(0) // 방 개수
  bathrooms   Int       @default(0) // 화장실 개수
  price       Int       @default(0) // 가격
  preference  Int       @default(1) // 선호도 (0: 하, 1: 중, 2: 상)
  images      String[]  @default([]) // 이미지 URLs (최대 5개)
  url         String?   // URL
  note        String?   // 비고
  isDeleted   Boolean   @default(false) // 삭제유무
  deletedAt   DateTime? // 삭제일시
  createdAt   DateTime  @default(now()) // 생성일
  updatedAt   DateTime  @updatedAt // 수정일시

  @@index([userId])
  @@index([category])
  @@index([region])
}

// 여행 일정 (일정계획)
model TravelSchedule {
  id            String    @id @default(cuid())
  userId        String    // 사용자 ID (소유자)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  updatedById   String?   // 마지막 수정자 ID
  updatedBy     User?     @relation("TravelScheduleUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  title         String    // 제목
  dueDate       DateTime? // 예정일
  note          String?   // 내용
  remindEnabled        Boolean   @default(true) // 알림 여부
  reminderSentDayBefore DateTime? // 전날 오전 9시 알림 전송 여부
  reminderSentDayOf     DateTime? // 당일 오전 9시 알림 전송 여부
  isDeleted             Boolean   @default(false)
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([dueDate])
}

